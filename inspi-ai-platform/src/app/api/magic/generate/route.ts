/**
 * Mock AIæ•™å­¦é­”æ³•å¸ˆ - ç”Ÿæˆæ•™å­¦å¡ç‰‡API
 * éµå¾ª"å…ˆè®©å®ƒå·¥ä½œï¼Œå†è®©å®ƒå®Œç¾"åŸåˆ™
 */

import { NextRequest, NextResponse } from 'next/server';
import type { GenerateCardsRequest, GenerateCardsResponse } from '@/types/teaching';

// Mockæ•™å­¦å¡ç‰‡æ•°æ®
const mockCards = {
  æ•°å­¦: {
    'ä¸¤ä½æ•°åŠ æ³•': [
      {
        id: 'card-1',
        type: 'visualization' as const,
        title: 'å¯è§†åŒ–ç†è§£',
        content: 'æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰23ä¸ªè‹¹æœï¼Œæœ‹å‹åˆç»™äº†ä½ 15ä¸ªè‹¹æœã€‚æˆ‘ä»¬å¯ä»¥ç”¨å°æ–¹å—æ¥è¡¨ç¤ºï¼š\n\nğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ (20ä¸ª)\nğŸŸ¦ğŸŸ¦ğŸŸ¦ (3ä¸ª)\n\nğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ (10ä¸ª)\nğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ (5ä¸ª)\n\nå…ˆæŠŠåä½ç›¸åŠ ï¼š20 + 10 = 30\nå†æŠŠä¸ªä½ç›¸åŠ ï¼š3 + 5 = 8\næœ€ååˆå¹¶ï¼š30 + 8 = 38',
        explanation: 'é€šè¿‡è§†è§‰åŒ–çš„æ–¹å¼ï¼Œè®©å­¦ç”Ÿç›´è§‚ç†è§£ä¸¤ä½æ•°åŠ æ³•çš„è¿‡ç¨‹ï¼Œå…ˆå¤„ç†åä½ï¼Œå†å¤„ç†ä¸ªä½ã€‚'
      },
      {
        id: 'card-2',
        type: 'analogy' as const,
        title: 'ç±»æ¯”å»¶å±•',
        content: 'ä¸¤ä½æ•°åŠ æ³•å°±åƒæ•´ç†ç©å…·ç®±ï¼š\n\nğŸ§¸ ä¸ªä½æ•°å­—åƒæ•£è½çš„å°ç©å…·\nğŸ“¦ åä½æ•°å­—åƒè£…æ»¡ç©å…·çš„ç›’å­\n\nå½“æˆ‘ä»¬è®¡ç®—23 + 15æ—¶ï¼š\n- å…ˆæ•°ç›’å­ï¼š2ç›’ + 1ç›’ = 3ç›’\n- å†æ•°æ•£è½çš„ç©å…·ï¼š3ä¸ª + 5ä¸ª = 8ä¸ª\n- æœ€ååˆèµ·æ¥ï¼š3ç›’8ä¸ªç©å…· = 38ä¸ªç©å…·\n\nè¿™æ ·ï¼Œå¤æ‚çš„æ•°å­¦å˜æˆäº†ç®€å•çš„æ•´ç†æ¸¸æˆï¼',
        explanation: 'ç”¨å­©å­ç†Ÿæ‚‰çš„æ•´ç†ç©å…·åœºæ™¯æ¥ç±»æ¯”æ•°å­¦æ¦‚å¿µï¼Œé™ä½ç†è§£éš¾åº¦ã€‚'
      },
      {
        id: 'card-3',
        type: 'thinking' as const,
        title: 'å¯å‘æ€è€ƒ',
        content: 'ğŸ¤” æ€è€ƒæ—¶é—´ï¼š\n\nå¦‚æœä½ åœ¨å•†åº—ä¹°ä¸œè¥¿ï¼š\n- ä¸€æœ¬ä¹¦23å…ƒ\n- ä¸€æ”¯ç¬”15å…ƒ\n\né—®é¢˜1ï¼šä½ éœ€è¦å¸¦å¤šå°‘é’±ï¼Ÿ\né—®é¢˜2ï¼šå¦‚æœä½ å¸¦äº†50å…ƒï¼Œè¿˜å‰©å¤šå°‘é’±ï¼Ÿ\né—®é¢˜3ï¼šä½ èƒ½æƒ³å‡ºå…¶ä»–éœ€è¦ç”¨åˆ°ä¸¤ä½æ•°åŠ æ³•çš„ç”Ÿæ´»åœºæ™¯å—ï¼Ÿ\n\nğŸ’¡ æç¤ºï¼šæƒ³æƒ³ä½ çš„å¹´é¾„ã€èº«é«˜ã€æˆ–è€…æ”¶é›†çš„å¡ç‰‡æ•°é‡...',
        explanation: 'é€šè¿‡å®é™…ç”Ÿæ´»åœºæ™¯å¼•å‘æ€è€ƒï¼Œè®©å­¦ç”Ÿä¸»åŠ¨æ¢ç´¢æ•°å­¦åœ¨ç”Ÿæ´»ä¸­çš„åº”ç”¨ã€‚'
      },
      {
        id: 'card-4',
        type: 'interaction' as const,
        title: 'äº’åŠ¨æ°›å›´',
        content: 'ğŸ® æ•°å­—æ¥é¾™æ¸¸æˆï¼š\n\næ¸¸æˆè§„åˆ™ï¼š\n1. è€å¸ˆè¯´ä¸€ä¸ªä¸¤ä½æ•°ï¼ˆå¦‚23ï¼‰\n2. å­¦ç”Ÿè½®æµè¯´å¦ä¸€ä¸ªä¸¤ä½æ•°ï¼ˆå¦‚15ï¼‰\n3. å…¨ç­ä¸€èµ·è®¡ç®—ç»“æœï¼ˆ23 + 15 = 38ï¼‰\n4. ä¸‹ä¸€è½®ä»ç»“æœå¼€å§‹ï¼ˆ38 + ?ï¼‰\n\nğŸ† æŒ‘æˆ˜æ¨¡å¼ï¼š\n- çœ‹è°èƒ½æœ€å¿«è¯´å‡ºæ­£ç¡®ç­”æ¡ˆ\n- å°è¯•è®©ç»“æœæ­£å¥½ç­‰äº100\n- ç”¨æ‰‹åŠ¿è¡¨ç¤ºåä½å’Œä¸ªä½\n\nè®©æ•°å­¦å˜æˆå¿«ä¹çš„æ¸¸æˆï¼',
        explanation: 'é€šè¿‡æ¸¸æˆåŒ–çš„äº’åŠ¨æ–¹å¼ï¼Œæé«˜å­¦ç”Ÿå‚ä¸åº¦å’Œå­¦ä¹ å…´è¶£ã€‚'
      }
    ],
    'åˆ†æ•°æ¦‚å¿µ': [
      {
        id: 'card-5',
        type: 'visualization' as const,
        title: 'å¯è§†åŒ–ç†è§£',
        content: 'ğŸ• åˆ†æ•°å°±åƒåˆ†æŠ«è¨ï¼š\n\nä¸€æ•´ä¸ªæŠ«è¨ = 1\nåˆ‡æˆ2å—ï¼Œæ¯å—æ˜¯ 1/2\nåˆ‡æˆ4å—ï¼Œæ¯å—æ˜¯ 1/4\nåˆ‡æˆ8å—ï¼Œæ¯å—æ˜¯ 1/8\n\nğŸ“Š ç”¨å›¾å½¢è¡¨ç¤ºï¼š\nâšª = 1 (å®Œæ•´çš„åœ†)\nâ— = 1/2 (åŠä¸ªåœ†)\nâ—” = 1/4 (å››åˆ†ä¹‹ä¸€åœ†)\n\nåˆ†æ¯å‘Šè¯‰æˆ‘ä»¬åˆ†æˆå‡ ä»½ï¼Œåˆ†å­å‘Šè¯‰æˆ‘ä»¬å–äº†å‡ ä»½ã€‚',
        explanation: 'ç”¨æŠ«è¨å’Œå›¾å½¢ç›´è§‚å±•ç¤ºåˆ†æ•°æ¦‚å¿µï¼Œå¸®åŠ©å­¦ç”Ÿç†è§£åˆ†å­åˆ†æ¯çš„å«ä¹‰ã€‚'
      }
    ]
  },
  è¯­æ–‡: {
    'æ–‡ç« ä¸»æ—¨ç†è§£': [
      {
        id: 'card-6',
        type: 'visualization' as const,
        title: 'å¯è§†åŒ–ç†è§£',
        content: 'ğŸ“– ç†è§£æ–‡ç« ä¸»æ—¨å°±åƒå¯»å®ï¼š\n\nğŸ—ºï¸ æ–‡ç«  = å¯»å®åœ°å›¾\nğŸ’ ä¸»æ—¨ = å®è—ä½ç½®\nğŸ” å…³é”®è¯ = å¯»å®çº¿ç´¢\n\nå¯»å®æ­¥éª¤ï¼š\n1. å¿«é€Ÿæµè§ˆå…¨æ–‡ï¼ˆè§‚å¯Ÿåœ°å›¾ï¼‰\n2. æ‰¾å‡ºå…³é”®è¯å¥ï¼ˆæ”¶é›†çº¿ç´¢ï¼‰\n3. æ€è€ƒä½œè€…æƒ³è¡¨è¾¾ä»€ä¹ˆï¼ˆæ¨ç†å®è—ä½ç½®ï¼‰\n4. ç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼ˆæ‰¾åˆ°å®è—ï¼ï¼‰\n\nè®°ä½ï¼šä¸»æ—¨é€šå¸¸è—åœ¨å¼€å¤´ã€ç»“å°¾æˆ–åå¤å‡ºç°çš„åœ°æ–¹ï¼',
        explanation: 'ç”¨å¯»å®æ¸¸æˆæ¯”å–»é˜…è¯»ç†è§£è¿‡ç¨‹ï¼Œè®©æŠ½è±¡çš„æ¦‚å¿µå˜å¾—å…·ä½“æœ‰è¶£ã€‚'
      }
    ]
  }
};

export async function POST(request: NextRequest) {
  try {
    console.log('ğŸ”§ Using mock magic generate service');
    
    // 1. ç®€åŒ–çš„èº«ä»½éªŒè¯ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰tokenï¼‰
    const token = request.cookies.get('token')?.value || 
                  request.headers.get('authorization')?.replace('Bearer ', '');
    
    if (!token) {
      return NextResponse.json(
        { error: 'Authentication required' },
        { status: 401 }
      );
    }

    // 2. è§£æè¯·æ±‚ä½“
    const body: GenerateCardsRequest = await request.json();
    const { knowledgePoint, subject, gradeLevel } = body;

    // 3. éªŒè¯è¾“å…¥
    if (!knowledgePoint || knowledgePoint.trim().length === 0) {
      return NextResponse.json(
        { error: 'è¯·è¾“å…¥çŸ¥è¯†ç‚¹' },
        { status: 400 }
      );
    }

    if (knowledgePoint.length > 100) {
      return NextResponse.json(
        { error: 'çŸ¥è¯†ç‚¹é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦' },
        { status: 400 }
      );
    }

    // 4. æ¨¡æ‹ŸAIç”Ÿæˆå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 1000));

    // 5. è·å–mockå¡ç‰‡æ•°æ®
    let cards = [];
    
    if (mockCards[subject] && mockCards[subject][knowledgePoint]) {
      cards = mockCards[subject][knowledgePoint];
    } else {
      // ç”Ÿæˆé€šç”¨çš„mockå¡ç‰‡
      cards = [
        {
          id: `card-${Date.now()}-1`,
          type: 'visualization' as const,
          title: 'å¯è§†åŒ–ç†è§£',
          content: `è®©æˆ‘ä»¬ç”¨å›¾åƒæ¥ç†è§£"${knowledgePoint}"ï¼š\n\né€šè¿‡å…·ä½“çš„ä¾‹å­å’Œå›¾è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°æŒæ¡è¿™ä¸ªæ¦‚å¿µã€‚æƒ³è±¡ä¸€ä¸‹ç›¸å…³çš„åœºæ™¯ï¼Œç”¨ä½ ç†Ÿæ‚‰çš„äº‹ç‰©æ¥ç±»æ¯”è¿™ä¸ªçŸ¥è¯†ç‚¹ã€‚\n\nè¿™æ ·çš„è§†è§‰åŒ–æ–¹æ³•èƒ½å¸®åŠ©ä½ æ›´æ·±å…¥åœ°ç†è§£å’Œè®°å¿†ã€‚`,
          explanation: `é€šè¿‡è§†è§‰åŒ–çš„æ–¹å¼å¸®åŠ©å­¦ç”Ÿç†è§£${knowledgePoint}çš„æ ¸å¿ƒæ¦‚å¿µã€‚`
        },
        {
          id: `card-${Date.now()}-2`,
          type: 'analogy' as const,
          title: 'ç±»æ¯”å»¶å±•',
          content: `"${knowledgePoint}"å°±åƒç”Ÿæ´»ä¸­çš„å¾ˆå¤šç°è±¡ï¼š\n\næˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ¯”ä½œæ—¥å¸¸ç”Ÿæ´»ä¸­ç†Ÿæ‚‰çš„äº‹ç‰©ï¼Œè¿™æ ·å°±èƒ½æ›´å®¹æ˜“ç†è§£å…¶ä¸­çš„è§„å¾‹å’Œç‰¹ç‚¹ã€‚\n\né€šè¿‡è¿™ç§ç±»æ¯”ï¼Œå¤æ‚çš„æ¦‚å¿µå˜å¾—ç®€å•æ˜“æ‡‚ã€‚`,
          explanation: `ç”¨ç”Ÿæ´»ä¸­çš„ç±»æ¯”å¸®åŠ©å­¦ç”Ÿç†è§£${knowledgePoint}ã€‚`
        },
        {
          id: `card-${Date.now()}-3`,
          type: 'thinking' as const,
          title: 'å¯å‘æ€è€ƒ',
          content: `ğŸ¤” å…³äº"${knowledgePoint}"ï¼Œè®©æˆ‘ä»¬æ€è€ƒï¼š\n\n1. è¿™ä¸ªæ¦‚å¿µåœ¨ç”Ÿæ´»ä¸­æœ‰å“ªäº›åº”ç”¨ï¼Ÿ\n2. ä½ èƒ½ä¸¾å‡ºç›¸å…³çš„ä¾‹å­å—ï¼Ÿ\n3. å¦‚æœæ²¡æœ‰è¿™ä¸ªæ¦‚å¿µï¼Œä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ\n\nğŸ’¡ è¯•ç€ä»ä¸åŒè§’åº¦æ€è€ƒè¿™ä¸ªé—®é¢˜ã€‚`,
          explanation: `é€šè¿‡å¯å‘æ€§é—®é¢˜å¼•å¯¼å­¦ç”Ÿæ·±å…¥æ€è€ƒ${knowledgePoint}ã€‚`
        },
        {
          id: `card-${Date.now()}-4`,
          type: 'interaction' as const,
          title: 'äº’åŠ¨æ°›å›´',
          content: `ğŸ® è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢"${knowledgePoint}"ï¼š\n\näº’åŠ¨æ´»åŠ¨ï¼š\n- å°ç»„è®¨è®ºç›¸å…³è¯é¢˜\n- åˆ†äº«ä¸ªäººç†è§£å’Œç»éªŒ\n- ä¸€èµ·è§£å†³ç›¸å…³é—®é¢˜\n- åˆ›é€ æ€§åœ°åº”ç”¨è¿™ä¸ªæ¦‚å¿µ\n\nè®©å­¦ä¹ å˜å¾—æ›´æœ‰è¶£ï¼`,
          explanation: `é€šè¿‡äº’åŠ¨æ´»åŠ¨æé«˜å­¦ç”Ÿå¯¹${knowledgePoint}çš„å‚ä¸åº¦å’Œç†è§£ã€‚`
        }
      ];
    }

    // 6. ç”Ÿæˆä¼šè¯ID
    const sessionId = `mock_session_${Date.now()}`;

    // 7. æ„å»ºå“åº”
    const response: GenerateCardsResponse = {
      cards,
      sessionId,
      usage: {
        current: 1,
        limit: 10, // Mockå…è´¹ç”¨æˆ·é™åˆ¶
        remaining: 9
      }
    };

    console.log('âœ… Mock cards generated successfully:', cards.length, 'cards');

    return NextResponse.json(response);

  } catch (error) {
    console.error('Mock generate cards error:', error);
    
    if (error instanceof Error) {
      return NextResponse.json(
        { error: error.message },
        { status: 500 }
      );
    }

    return NextResponse.json(
      { error: 'AIç”ŸæˆæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    );
  }
}