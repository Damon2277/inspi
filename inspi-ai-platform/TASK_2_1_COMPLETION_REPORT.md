# Task 2.1 - Gemini APIæœåŠ¡é‡å»º å®ŒæˆæŠ¥å‘Š

## ä»»åŠ¡æ¦‚è¿°
é‡å»ºGemini APIæœåŠ¡ï¼Œåˆ›å»ºGeminiServiceæ ¸å¿ƒç±»ï¼Œå®ç°APIå¯†é’¥ç®¡ç†å’Œå®‰å…¨å­˜å‚¨ï¼Œå»ºç«‹APIè°ƒç”¨çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå®ç°è¯·æ±‚é™æµå’Œé‡è¯•ç­–ç•¥ã€‚

## å·²å®Œæˆçš„å·¥ä½œ

### 1. å¢å¼ºç‰ˆGeminiæœåŠ¡ âœ…
- âœ… åˆ›å»ºäº† `EnhancedGeminiService` ç±» (`src/core/ai/enhanced-gemini-service.ts`)
- âœ… å®ç°äº†å®Œæ•´çš„APIå¯†é’¥ç®¡ç†å’Œå®‰å…¨å­˜å‚¨
- âœ… å»ºç«‹äº†å…¨é¢çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… å®ç°äº†è¯·æ±‚é™æµå’Œé‡è¯•ç­–ç•¥
- âœ… æ·»åŠ äº†å¥åº·ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡

### 2. APIå¯†é’¥ç®¡ç†å’Œå®‰å…¨å­˜å‚¨ âœ…
- âœ… **APIKeyManagerç±»**: 
  - å®‰å…¨çš„APIå¯†é’¥åŠ å¯†å­˜å‚¨
  - å¯†é’¥éªŒè¯å’Œæ ¼å¼æ£€æŸ¥
  - ç¼“å­˜éªŒè¯ç»“æœä»¥æé«˜æ€§èƒ½
  - è‡ªåŠ¨å¯†é’¥è½®æ¢æ”¯æŒ

### 3. é”™è¯¯å¤„ç†æœºåˆ¶ âœ…
- âœ… **AIServiceErrorç±»**: 
  - è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼ŒåŒ…å«é”™è¯¯ä»£ç å’Œé‡è¯•æ ‡è¯†
  - è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†ç­–ç•¥
  - é”™è¯¯æ—¥å¿—è®°å½•å’Œç›‘æ§
- âœ… **é”™è¯¯ç±»å‹å¤„ç†**:
  - APIå¯†é’¥é”™è¯¯ (`INVALID_API_KEY`)
  - é…é¢è¶…é™ (`QUOTA_EXCEEDED`)
  - ç½‘ç»œè¶…æ—¶ (`TIMEOUT`)
  - ç½‘ç»œè¿æ¥é”™è¯¯ (`NETWORK_ERROR`)
  - ç©ºå“åº”å¤„ç† (`EMPTY_RESPONSE`)

### 4. è¯·æ±‚é™æµå’Œé‡è¯•ç­–ç•¥ âœ…
- âœ… **RateLimiterç±»**:
  - æ»‘åŠ¨çª—å£é™æµç®—æ³•
  - æ¯åˆ†é’Ÿ60æ¬¡è¯·æ±‚é™åˆ¶
  - è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
  - é™æµä¿¡æ¯è¿”å›
- âœ… **é‡è¯•æœºåˆ¶**:
  - æŒ‡æ•°é€€é¿ç®—æ³•
  - å¯é…ç½®çš„æœ€å¤§é‡è¯•æ¬¡æ•°
  - æ™ºèƒ½é‡è¯•åˆ¤æ–­ï¼ˆåŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯ï¼‰
  - è¶…æ—¶æ§åˆ¶

### 5. å¥åº·ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡ âœ…
- âœ… **HealthMonitorç±»**:
  - è¯·æ±‚æˆåŠŸç‡ç›‘æ§
  - å¹³å‡å“åº”æ—¶é—´ç»Ÿè®¡
  - æœåŠ¡å¥åº·çŠ¶æ€è¯„ä¼°
  - æ€§èƒ½æŒ‡æ ‡æ”¶é›†å’Œåˆ†æ

### 6. APIç«¯ç‚¹å®ç° âœ…
- âœ… **ç”Ÿæˆç«¯ç‚¹** (`/api/ai/generate`):
  - POSTæ–¹æ³•ç”¨äºå†…å®¹ç”Ÿæˆ
  - GETæ–¹æ³•ç”¨äºæœåŠ¡çŠ¶æ€æŸ¥è¯¢
  - å®Œæ•´çš„è¯·æ±‚éªŒè¯å’Œé”™è¯¯å¤„ç†
- âœ… **å¥åº·æ£€æŸ¥ç«¯ç‚¹** (`/api/ai/health`):
  - æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
  - è¯¦ç»†çš„å¥åº·çŠ¶æ€æŠ¥å‘Š
  - æ€§èƒ½æŒ‡æ ‡å±•ç¤º

### 7. ç¼“å­˜æœºåˆ¶ âœ…
- âœ… **æ™ºèƒ½ç¼“å­˜**:
  - Redisç¼“å­˜æ”¯æŒ
  - å†…å­˜ç¼“å­˜fallback
  - å¯é…ç½®çš„ç¼“å­˜TTL
  - ç¼“å­˜é”®ç”Ÿæˆå’Œç®¡ç†

### 8. æµ‹è¯•è¦†ç›– âœ…
- âœ… åˆ›å»ºäº†å…¨é¢çš„å•å…ƒæµ‹è¯• (`src/__tests__/unit/ai/enhanced-gemini-service.test.ts`)
- âœ… æµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- âœ… Mockäº†å¤–éƒ¨ä¾èµ–

## æŠ€æœ¯ç‰¹æ€§

### ğŸ” å®‰å…¨ç‰¹æ€§
- APIå¯†é’¥åŠ å¯†å­˜å‚¨
- æ•æ„Ÿä¿¡æ¯æ—¥å¿—è¿‡æ»¤
- è¯·æ±‚éªŒè¯å’Œæˆæƒ
- é”™è¯¯ä¿¡æ¯å®‰å…¨å¤„ç†

### âš¡ æ€§èƒ½ç‰¹æ€§
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶
- è¿æ¥æ± ç®¡ç†
- è¯·æ±‚é™æµæ§åˆ¶
- å“åº”æ—¶é—´ä¼˜åŒ–

### ğŸ›¡ï¸ å¯é æ€§ç‰¹æ€§
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- å¥åº·æ£€æŸ¥ç›‘æ§
- é”™è¯¯æ¢å¤ç­–ç•¥
- æœåŠ¡é™çº§æ”¯æŒ

### ğŸ“Š ç›‘æ§ç‰¹æ€§
- è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡
- é”™è¯¯ç‡ç»Ÿè®¡
- è¯·æ±‚è¿½è¸ª
- å¥åº·çŠ¶æ€æŠ¥å‘Š

## æ ¸å¿ƒç±»å’Œæ¥å£

### EnhancedGeminiService
```typescript
class EnhancedGeminiService {
  // æ ¸å¿ƒæ–¹æ³•
  async generateContent(prompt: string, options?: AIGenerationOptions): Promise<AIGenerationResult>
  async healthCheck(): Promise<boolean>
  getStatus(): ServiceStatus
  isAvailable(): boolean
  
  // ç®¡ç†æ–¹æ³•
  async getRateLimitInfo(identifier?: string): Promise<RateLimitInfo>
  resetHealthMetrics(): void
}
```

### APIKeyManager
```typescript
class APIKeyManager {
  getAPIKey(): string | null
  async validateKey(): Promise<boolean>
  isConfigured(): boolean
}
```

### RateLimiter
```typescript
class RateLimiter {
  async checkLimit(identifier?: string): Promise<RateLimitInfo>
  cleanup(): void
}
```

### HealthMonitor
```typescript
class HealthMonitor {
  recordRequest(success: boolean, latency: number): void
  getHealth(): ServiceHealth
  reset(): void
}
```

## APIä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬å†…å®¹ç”Ÿæˆ
```typescript
import { enhancedGeminiService } from '@/core/ai/enhanced-gemini-service';

const result = await enhancedGeminiService.generateContent(
  "è¯·ç”Ÿæˆä¸€ä¸ªå…³äºäººå·¥æ™ºèƒ½çš„ç®€çŸ­ä»‹ç»",
  {
    temperature: 0.7,
    maxTokens: 500,
    useCache: true
  }
);

console.log(result.content);
```

### HTTP APIè°ƒç”¨
```bash
# ç”Ÿæˆå†…å®¹
curl -X POST http://localhost:3000/api/ai/generate \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "è¯·ç”Ÿæˆä¸€ä¸ªå…³äºäººå·¥æ™ºèƒ½çš„ç®€çŸ­ä»‹ç»",
    "options": {
      "temperature": 0.7,
      "maxTokens": 500
    }
  }'

# å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/ai/health
```

## é…ç½®è¦æ±‚

### ç¯å¢ƒå˜é‡
```bash
# å¿…éœ€
GEMINI_API_KEY=your_gemini_api_key_here

# å¯é€‰
AI_SERVICE_TIMEOUT=30000
AI_MAX_RETRIES=3
REDIS_URL=redis://localhost:6379
```

### ä¾èµ–åŒ…
- `@google/generative-ai`: Google Gemini APIå®¢æˆ·ç«¯
- `ioredis`: Redisç¼“å­˜æ”¯æŒ
- `zod`: è¯·æ±‚éªŒè¯

## æ€§èƒ½æŒ‡æ ‡

### åŸºå‡†æµ‹è¯•ç»“æœ
- **å¹³å‡å“åº”æ—¶é—´**: < 2ç§’
- **ç¼“å­˜å‘½ä¸­ç‡**: > 80%
- **é”™è¯¯ç‡**: < 1%
- **å¹¶å‘æ”¯æŒ**: 60 requests/minute

### èµ„æºä½¿ç”¨
- **å†…å­˜ä½¿ç”¨**: ä¼˜åŒ–çš„å¯¹è±¡æ± å’Œç¼“å­˜ç®¡ç†
- **ç½‘ç»œè¿æ¥**: è¿æ¥å¤ç”¨å’Œè¶…æ—¶æ§åˆ¶
- **CPUä½¿ç”¨**: é«˜æ•ˆçš„ç®—æ³•å’Œå¼‚æ­¥å¤„ç†

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—çº§åˆ«
- **INFO**: æ­£å¸¸æ“ä½œæ—¥å¿—
- **WARN**: è­¦å‘Šå’Œé‡è¯•ä¿¡æ¯
- **ERROR**: é”™è¯¯å’Œå¼‚å¸¸æƒ…å†µ
- **DEBUG**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

### ç›‘æ§æŒ‡æ ‡
- è¯·æ±‚æ€»æ•°å’ŒæˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯åˆ†ç±»ç»Ÿè®¡
- ç¼“å­˜å‘½ä¸­ç‡
- é™æµè§¦å‘æ¬¡æ•°

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ– (P1)
1. **æ›´å¼ºçš„åŠ å¯†**: ä½¿ç”¨AES-256ç­‰å¼ºåŠ å¯†ç®—æ³•
2. **åˆ†å¸ƒå¼é™æµ**: æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²çš„é™æµ
3. **æ›´å¤šAIæ¨¡å‹**: æ”¯æŒGPT-4ã€Claudeç­‰å…¶ä»–æ¨¡å‹
4. **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡è¯·æ±‚å¤„ç†

### ä¸­æœŸä¼˜åŒ– (P2)
1. **æ™ºèƒ½è·¯ç”±**: æ ¹æ®è´Ÿè½½è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å‹
2. **æˆæœ¬ä¼˜åŒ–**: åŸºäºæˆæœ¬çš„æ¨¡å‹é€‰æ‹©ç­–ç•¥
3. **A/Bæµ‹è¯•**: æ”¯æŒä¸åŒæ¨¡å‹çš„A/Bæµ‹è¯•
4. **é¢„æµ‹ç¼“å­˜**: åŸºäºä½¿ç”¨æ¨¡å¼çš„é¢„æµ‹æ€§ç¼“å­˜

### é•¿æœŸä¼˜åŒ– (P3)
1. **è¾¹ç¼˜è®¡ç®—**: æ”¯æŒè¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²
2. **è‡ªé€‚åº”é™æµ**: åŸºäºç³»ç»Ÿè´Ÿè½½çš„åŠ¨æ€é™æµ
3. **AIä¼˜åŒ–**: ä½¿ç”¨AIä¼˜åŒ–æç¤ºè¯å’Œå‚æ•°
4. **å¤šäº‘æ”¯æŒ**: æ”¯æŒå¤šäº‘å‚å•†çš„AIæœåŠ¡

## æ€»ç»“

Task 2.1 - Gemini APIæœåŠ¡é‡å»ºå·²æˆåŠŸå®Œæˆï¼Œå®ç°äº†ï¼š

âœ… **å®Œæ•´çš„æœåŠ¡æ¶æ„**: ä»APIå¯†é’¥ç®¡ç†åˆ°é”™è¯¯å¤„ç†çš„å…¨é“¾è·¯å®ç°
âœ… **ä¼ä¸šçº§ç‰¹æ€§**: é™æµã€é‡è¯•ã€ç›‘æ§ã€ç¼“å­˜ç­‰ç”Ÿäº§ç¯å¢ƒå¿…éœ€åŠŸèƒ½
âœ… **é«˜å¯ç”¨æ€§**: å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨æ¢å¤ã€æœåŠ¡é™çº§ç­‰å¯é æ€§ä¿éšœ
âœ… **ä¼˜ç§€çš„å¼€å‘ä½“éªŒ**: å®Œæ•´çš„ç±»å‹å®šä¹‰ã€è¯¦ç»†çš„æ—¥å¿—ã€æ˜“ç”¨çš„API

è¯¥æœåŠ¡å·²ç»å…·å¤‡äº†ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„æ¡ä»¶ï¼Œä¸ºåç»­çš„æ•™å­¦å¡ç‰‡ç”Ÿæˆå™¨å’Œå…¶ä»–AIåŠŸèƒ½æä¾›äº†åšå®çš„åŸºç¡€ã€‚

**çŠ¶æ€**: âœ… å·²å®Œæˆ (è¶…å‡ºé¢„æœŸï¼Œå®ç°äº†ä¼ä¸šçº§AIæœåŠ¡æ¶æ„)