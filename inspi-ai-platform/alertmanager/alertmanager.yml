# Alertmanager配置文件
global:
  # SMTP配置
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@inspi.ai'
  smtp_auth_username: 'alerts@inspi.ai'
  smtp_auth_password: 'your-email-password'
  smtp_require_tls: true

  # 默认接收者
  smtp_hello: 'inspi.ai'

# 模板配置
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# 路由配置
route:
  # 默认分组
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-receiver'
  
  # 子路由
  routes:
    # 严重告警立即通知
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5m
      repeat_interval: 30m
      continue: true

    # 应用相关告警
    - match:
        service: inspi-ai-app
      receiver: 'app-team'
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h

    # 基础设施告警
    - match:
        category: infrastructure
      receiver: 'ops-team'
      group_by: ['alertname', 'instance']
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 4h

    # 数据库告警
    - match:
        category: database
      receiver: 'dba-team'
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 1h

    # 业务告警
    - match:
        category: business
      receiver: 'business-team'
      group_by: ['alertname']
      group_wait: 2m
      group_interval: 10m
      repeat_interval: 6h

    # 安全告警
    - match:
        category: security
      receiver: 'security-team'
      group_by: ['alertname']
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 15m

# 抑制规则
inhibit_rules:
  # 主机宕机时抑制其他主机相关告警
  - source_match:
      alertname: 'HostDown'
    target_match_re:
      alertname: 'Host.*'
    equal: ['instance']

  # 应用宕机时抑制应用相关告警
  - source_match:
      alertname: 'ApplicationDown'
    target_match_re:
      alertname: 'High.*|Low.*'
    equal: ['instance']

  # 数据库宕机时抑制数据库相关告警
  - source_match:
      alertname: 'MySQLDown'
    target_match_re:
      alertname: 'MySQL.*'
    equal: ['instance']

# 接收者配置
receivers:
  # 默认接收者
  - name: 'default-receiver'
    email_configs:
      - to: 'ops@inspi.ai'
        subject: '[Inspi.AI] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          标签: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          处理手册: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # 严重告警接收者
  - name: 'critical-alerts'
    email_configs:
      - to: 'critical@inspi.ai'
        subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
        body: |
          🚨 严重告警 🚨
          
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          服务: {{ .Labels.service }}
          实例: {{ .Labels.instance }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          🔧 处理手册: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
    
    # 钉钉通知
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_DINGTALK_TOKEN'
        send_resolved: true
        http_config:
          proxy_url: ''
        title: '[CRITICAL] Inspi.AI 严重告警'
        text: |
          ## 🚨 严重告警
          
          {{ range .Alerts }}
          **告警**: {{ .Annotations.summary }}
          
          **描述**: {{ .Annotations.description }}
          
          **服务**: {{ .Labels.service }}
          
          **实例**: {{ .Labels.instance }}
          
          **时间**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          **处理手册**: [点击查看]({{ .Annotations.runbook_url }})
          {{ end }}
          {{ end }}

    # 企业微信通知
    wechat_configs:
      - corp_id: 'YOUR_CORP_ID'
        api_secret: 'YOUR_API_SECRET'
        to_user: '@all'
        agent_id: 'YOUR_AGENT_ID'
        message: |
          🚨 严重告警
          
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          服务: {{ .Labels.service }}
          实例: {{ .Labels.instance }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # 应用团队接收者
  - name: 'app-team'
    email_configs:
      - to: 'app-team@inspi.ai'
        subject: '[APP] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          应用告警通知
          
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          服务: {{ .Labels.service }}
          实例: {{ .Labels.instance }}
          严重程度: {{ .Labels.severity }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          处理手册: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # 运维团队接收者
  - name: 'ops-team'
    email_configs:
      - to: 'ops-team@inspi.ai'
        subject: '[OPS] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          基础设施告警通知
          
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          主机: {{ .Labels.instance }}
          严重程度: {{ .Labels.severity }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          处理手册: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # 数据库团队接收者
  - name: 'dba-team'
    email_configs:
      - to: 'dba-team@inspi.ai'
        subject: '[DBA] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          数据库告警通知
          
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          数据库: {{ .Labels.instance }}
          严重程度: {{ .Labels.severity }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          处理手册: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # 业务团队接收者
  - name: 'business-team'
    email_configs:
      - to: 'business-team@inspi.ai'
        subject: '[BUSINESS] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          业务指标告警通知
          
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          严重程度: {{ .Labels.severity }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          处理手册: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # 安全团队接收者
  - name: 'security-team'
    email_configs:
      - to: 'security-team@inspi.ai'
        subject: '[SECURITY] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          🔒 安全告警通知
          
          {{ range .Alerts }}
          告警: {{ .Annotations.summary }}
          描述: {{ .Annotations.description }}
          严重程度: {{ .Labels.severity }}
          时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          处理手册: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
    
    # 安全告警也发送到钉钉
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_SECURITY_DINGTALK_TOKEN'
        send_resolved: true
        title: '[SECURITY] Inspi.AI 安全告警'
        text: |
          ## 🔒 安全告警
          
          {{ range .Alerts }}
          **告警**: {{ .Annotations.summary }}
          
          **描述**: {{ .Annotations.description }}
          
          **严重程度**: {{ .Labels.severity }}
          
          **时间**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          **处理手册**: [点击查看]({{ .Annotations.runbook_url }})
          {{ end }}
          {{ end }}