# è´¨é‡é—¨ç¦å¼ºåˆ¶æ‰§è¡Œå™¨
name: ðŸšª Quality Gate Enforcer

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼ºåˆ¶æ‰§è¡Œè´¨é‡æ£€æŸ¥'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'
  # è´¨é‡é—¨ç¦é˜ˆå€¼
  COVERAGE_THRESHOLD: '85'
  PERFORMANCE_THRESHOLD: '3000'
  SECURITY_THRESHOLD: '0'
  CODE_QUALITY_THRESHOLD: '0'

jobs:
  # è´¨é‡é—¨ç¦é¢„æ£€æŸ¥
  quality-gate-precheck:
    name: ðŸ” è´¨é‡é—¨ç¦é¢„æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should_block: ${{ steps.precheck.outputs.should_block }}
      block_reason: ${{ steps.precheck.outputs.block_reason }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
        id: precheck
        run: |
          echo "ðŸ” æ£€æŸ¥å½“å‰ä»»åŠ¡çŠ¶æ€..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é˜»æ–­çŠ¶æ€çš„ä»»åŠ¡
          if grep -q "\[!\]" .kiro/specs/*/tasks.md; then
            echo "âŒ å‘çŽ°å­˜åœ¨é—®é¢˜çš„ä»»åŠ¡ï¼Œé˜»æ–­æµæ°´çº¿"
            echo "should_block=true" >> $GITHUB_OUTPUT
            echo "block_reason=å­˜åœ¨é—®é¢˜çŠ¶æ€çš„ä»»åŠ¡" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if grep -q "\[R\]" .kiro/specs/*/tasks.md; then
            echo "âŒ å‘çŽ°éœ€è¦è¿”å·¥çš„ä»»åŠ¡ï¼Œé˜»æ–­æµæ°´çº¿"
            echo "should_block=true" >> $GITHUB_OUTPUT
            echo "block_reason=å­˜åœ¨éœ€è¦è¿”å·¥çš„ä»»åŠ¡" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if grep -q "\[~\]" .kiro/specs/*/tasks.md; then
            echo "âš ï¸ å‘çŽ°éƒ¨åˆ†å®Œæˆçš„ä»»åŠ¡ï¼Œéœ€è¦å®Œå–„"
            echo "should_block=true" >> $GITHUB_OUTPUT
            echo "block_reason=å­˜åœ¨éƒ¨åˆ†å®Œæˆçš„ä»»åŠ¡" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… ä»»åŠ¡çŠ¶æ€æ£€æŸ¥é€šè¿‡"
          echo "should_block=false" >> $GITHUB_OUTPUT

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality-gate:
    name: ðŸ“Š ä»£ç è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: quality-gate-precheck
    if: needs.quality-gate-precheck.outputs.should_block != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: ESLintæ£€æŸ¥
        run: |
          echo "ðŸ” è¿è¡ŒESLintæ£€æŸ¥..."
          npm run lint -- --format json --output-file eslint-report.json || true
          
          # æ£€æŸ¥ESLinté”™è¯¯æ•°é‡
          ERROR_COUNT=$(node -p "JSON.parse(require('fs').readFileSync('eslint-report.json')).reduce((sum, file) => sum + file.errorCount, 0)")
          echo "ESLinté”™è¯¯æ•°é‡: $ERROR_COUNT"
          
          if [ $ERROR_COUNT -gt $CODE_QUALITY_THRESHOLD ]; then
            echo "âŒ ESLinté”™è¯¯æ•°é‡ ($ERROR_COUNT) è¶…è¿‡é˜ˆå€¼ ($CODE_QUALITY_THRESHOLD)"
            echo "QUALITY_GATE_FAILED=true" >> $GITHUB_ENV
            echo "FAILURE_REASON=ESLinté”™è¯¯è¶…æ ‡" >> $GITHUB_ENV
          else
            echo "âœ… ESLintæ£€æŸ¥é€šè¿‡"
          fi
      
      - name: TypeScriptç±»åž‹æ£€æŸ¥
        run: |
          echo "ðŸ” è¿è¡ŒTypeScriptç±»åž‹æ£€æŸ¥..."
          npm run type-check 2>&1 | tee typescript-report.txt || true
          
          # æ£€æŸ¥TypeScripté”™è¯¯
          if grep -q "error TS" typescript-report.txt; then
            echo "âŒ å‘çŽ°TypeScriptç±»åž‹é”™è¯¯"
            echo "QUALITY_GATE_FAILED=true" >> $GITHUB_ENV
            echo "FAILURE_REASON=TypeScriptç±»åž‹é”™è¯¯" >> $GITHUB_ENV
          else
            echo "âœ… TypeScriptç±»åž‹æ£€æŸ¥é€šè¿‡"
          fi
      
      - name: è´¨é‡é—¨ç¦ç»“æžœ
        run: |
          if [ "$QUALITY_GATE_FAILED" = "true" ]; then
            echo "âŒ ä»£ç è´¨é‡é—¨ç¦å¤±è´¥: $FAILURE_REASON"
            exit 1
          else
            echo "âœ… ä»£ç è´¨é‡é—¨ç¦é€šè¿‡"
          fi

  # æµ‹è¯•è¦†ç›–çŽ‡é—¨ç¦
  coverage-gate:
    name: ðŸ“ˆ æµ‹è¯•è¦†ç›–çŽ‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: quality-gate-precheck
    if: needs.quality-gate-precheck.outputs.should_block != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡
        run: |
          echo "ðŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š..."
          npm run test:unit -- --coverage --coverageReporters=json-summary
      
      - name: æ£€æŸ¥è¦†ç›–çŽ‡é—¨ç¦
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct)")
            echo "å½“å‰è¦†ç›–çŽ‡: ${COVERAGE}%"
            echo "è¦æ±‚è¦†ç›–çŽ‡: ${COVERAGE_THRESHOLD}%"
            
            if [ $COVERAGE -lt $COVERAGE_THRESHOLD ]; then
              echo "âŒ è¦†ç›–çŽ‡ ${COVERAGE}% ä½ŽäºŽé—¨ç¦è¦æ±‚ ${COVERAGE_THRESHOLD}%"
              echo "COVERAGE_GATE_FAILED=true" >> $GITHUB_ENV
              exit 1
            else
              echo "âœ… è¦†ç›–çŽ‡ ${COVERAGE}% è¾¾åˆ°é—¨ç¦è¦æ±‚"
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°è¦†ç›–çŽ‡æŠ¥å‘Šæ–‡ä»¶"
            echo "COVERAGE_GATE_FAILED=true" >> $GITHUB_ENV
            exit 1
          fi

  # å®‰å…¨é—¨ç¦
  security-gate:
    name: ðŸ”’ å®‰å…¨é—¨ç¦
    runs-on: ubuntu-latest
    needs: quality-gate-precheck
    if: needs.quality-gate-precheck.outputs.should_block != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: è¿è¡Œå®‰å…¨æ‰«æ
        run: |
          echo "ðŸ” è¿è¡Œnpm auditå®‰å…¨æ‰«æ..."
          npm audit --audit-level=high --json > audit-report.json || true
          
          # æ£€æŸ¥é«˜å±å’Œä¸¥é‡æ¼æ´ž
          HIGH_VULNS=$(node -p "JSON.parse(require('fs').readFileSync('audit-report.json')).metadata?.vulnerabilities?.high || 0")
          CRITICAL_VULNS=$(node -p "JSON.parse(require('fs').readFileSync('audit-report.json')).metadata?.vulnerabilities?.critical || 0")
          TOTAL_HIGH_CRITICAL=$((HIGH_VULNS + CRITICAL_VULNS))
          
          echo "é«˜å±æ¼æ´ž: $HIGH_VULNS"
          echo "ä¸¥é‡æ¼æ´ž: $CRITICAL_VULNS"
          echo "æ€»è®¡é«˜å±åŠä»¥ä¸Š: $TOTAL_HIGH_CRITICAL"
          
          if [ $TOTAL_HIGH_CRITICAL -gt $SECURITY_THRESHOLD ]; then
            echo "âŒ å‘çŽ° $TOTAL_HIGH_CRITICAL ä¸ªé«˜å±åŠä»¥ä¸Šå®‰å…¨æ¼æ´žï¼Œè¶…è¿‡é˜ˆå€¼ $SECURITY_THRESHOLD"
            echo "SECURITY_GATE_FAILED=true" >> $GITHUB_ENV
            exit 1
          else
            echo "âœ… å®‰å…¨æ‰«æé€šè¿‡ï¼Œæ— é«˜å±æ¼æ´ž"
          fi

  # æ€§èƒ½é—¨ç¦ï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
  performance-gate:
    name: âš¡ æ€§èƒ½é—¨ç¦
    runs-on: ubuntu-latest
    needs: quality-gate-precheck
    if: needs.quality-gate-precheck.outputs.should_block != 'true' && github.ref == 'refs/heads/main'
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
      redis:
        image: redis:7.2
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: Build and start application
        run: |
          npm run build
          npm start &
          sleep 30
          curl -f http://localhost:3000 || exit 1
      
      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
          npm run test:performance:basic
      
      - name: æ£€æŸ¥æ€§èƒ½é—¨ç¦
        run: |
          # è¿™é‡Œåº”è¯¥æ£€æŸ¥æ€§èƒ½æµ‹è¯•ç»“æžœ
          # ç®€åŒ–ç‰ˆæœ¬ï¼Œå®žé™…åº”è¯¥è§£æžæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
          echo "âœ… æ€§èƒ½é—¨ç¦æ£€æŸ¥é€šè¿‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰"

  # æœ€ç»ˆè´¨é‡é—¨ç¦å†³ç­–
  final-quality-gate:
    name: ðŸŽ¯ æœ€ç»ˆè´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: [quality-gate-precheck, code-quality-gate, coverage-gate, security-gate, performance-gate]
    if: always()
    
    steps:
      - name: è´¨é‡é—¨ç¦å†³ç­–
        run: |
          echo "ðŸŽ¯ æœ€ç»ˆè´¨é‡é—¨ç¦å†³ç­–..."
          
          # æ£€æŸ¥é¢„æ£€æŸ¥ç»“æžœ
          if [ "${{ needs.quality-gate-precheck.outputs.should_block }}" = "true" ]; then
            echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥: ${{ needs.quality-gate-precheck.outputs.block_reason }}"
            echo "FINAL_DECISION=BLOCK" >> $GITHUB_ENV
            echo "BLOCK_REASON=${{ needs.quality-gate-precheck.outputs.block_reason }}" >> $GITHUB_ENV
          fi
          
          # æ£€æŸ¥å„ä¸ªé—¨ç¦ç»“æžœ
          if [ "${{ needs.code-quality-gate.result }}" = "failure" ]; then
            echo "âŒ ä»£ç è´¨é‡é—¨ç¦å¤±è´¥"
            echo "FINAL_DECISION=BLOCK" >> $GITHUB_ENV
            echo "BLOCK_REASON=ä»£ç è´¨é‡ä¸è¾¾æ ‡" >> $GITHUB_ENV
          fi
          
          if [ "${{ needs.coverage-gate.result }}" = "failure" ]; then
            echo "âŒ æµ‹è¯•è¦†ç›–çŽ‡é—¨ç¦å¤±è´¥"
            echo "FINAL_DECISION=BLOCK" >> $GITHUB_ENV
            echo "BLOCK_REASON=æµ‹è¯•è¦†ç›–çŽ‡ä¸è¾¾æ ‡" >> $GITHUB_ENV
          fi
          
          if [ "${{ needs.security-gate.result }}" = "failure" ]; then
            echo "âŒ å®‰å…¨é—¨ç¦å¤±è´¥"
            echo "FINAL_DECISION=BLOCK" >> $GITHUB_ENV
            echo "BLOCK_REASON=å­˜åœ¨å®‰å…¨æ¼æ´ž" >> $GITHUB_ENV
          fi
          
          if [ "${{ needs.performance-gate.result }}" = "failure" ]; then
            echo "âŒ æ€§èƒ½é—¨ç¦å¤±è´¥"
            echo "FINAL_DECISION=BLOCK" >> $GITHUB_ENV
            echo "BLOCK_REASON=æ€§èƒ½ä¸è¾¾æ ‡" >> $GITHUB_ENV
          fi
          
          # æœ€ç»ˆå†³ç­–
          if [ "$FINAL_DECISION" = "BLOCK" ]; then
            echo "ðŸš« è´¨é‡é—¨ç¦æœ€ç»ˆå†³ç­–: é˜»æ–­"
            echo "ðŸ” é˜»æ–­åŽŸå› : $BLOCK_REASON"
            echo ""
            echo "ðŸ“‹ è§£å†³å»ºè®®:"
            echo "1. ä¿®å¤æ‰€æœ‰è´¨é‡é—®é¢˜"
            echo "2. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡"
            echo "3. æé«˜ä»£ç è¦†ç›–çŽ‡"
            echo "4. ä¿®å¤å®‰å…¨æ¼æ´ž"
            echo "5. ä¼˜åŒ–æ€§èƒ½æŒ‡æ ‡"
            echo "6. é‡æ–°æäº¤ä»£ç "
            exit 1
          else
            echo "âœ… è´¨é‡é—¨ç¦æœ€ç»ˆå†³ç­–: é€šè¿‡"
            echo "ðŸŽ‰ æ‰€æœ‰è´¨é‡æ£€æŸ¥éƒ½å·²é€šè¿‡ï¼Œå¯ä»¥ç»§ç»­æµç¨‹"
          fi
      
      - name: åˆ›å»ºè´¨é‡é—¨ç¦æŠ¥å‘Š
        if: always()
        run: |
          cat > quality-gate-report.md << EOF
          # ðŸšª è´¨é‡é—¨ç¦æŠ¥å‘Š
          
          **æ—¶é—´**: $(date)
          **åˆ†æ”¯**: ${{ github.ref_name }}
          **æäº¤**: ${{ github.sha }}
          
          ## ðŸ“Š æ£€æŸ¥ç»“æžœ
          
          | æ£€æŸ¥é¡¹ | çŠ¶æ€ | ç»“æžœ |
          |--------|------|------|
          | ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ | ${{ needs.quality-gate-precheck.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | ${{ needs.quality-gate-precheck.outputs.block_reason || 'æ­£å¸¸' }} |
          | ä»£ç è´¨é‡ | ${{ needs.code-quality-gate.result == 'success' && 'âœ… é€šè¿‡' || needs.code-quality-gate.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | ESLint + TypeScript |
          | æµ‹è¯•è¦†ç›–çŽ‡ | ${{ needs.coverage-gate.result == 'success' && 'âœ… é€šè¿‡' || needs.coverage-gate.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | â‰¥ ${{ env.COVERAGE_THRESHOLD }}% |
          | å®‰å…¨æ‰«æ | ${{ needs.security-gate.result == 'success' && 'âœ… é€šè¿‡' || needs.security-gate.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | æ— é«˜å±æ¼æ´ž |
          | æ€§èƒ½æµ‹è¯• | ${{ needs.performance-gate.result == 'success' && 'âœ… é€šè¿‡' || needs.performance-gate.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡ |
          
          ## ðŸŽ¯ æœ€ç»ˆå†³ç­–
          
          ${{ env.FINAL_DECISION == 'BLOCK' && 'ðŸš« **é˜»æ–­**: å­˜åœ¨è´¨é‡é—®é¢˜ï¼Œéœ€è¦ä¿®å¤åŽé‡æ–°æäº¤' || 'âœ… **é€šè¿‡**: æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥ç»§ç»­æµç¨‹' }}
          
          ${{ env.BLOCK_REASON && format('**é˜»æ–­åŽŸå› **: {0}', env.BLOCK_REASON) || '' }}
          
          ---
          *è‡ªåŠ¨ç”Ÿæˆçš„è´¨é‡é—¨ç¦æŠ¥å‘Š*
          EOF
          
          echo "ðŸ“„ è´¨é‡é—¨ç¦æŠ¥å‘Šå·²ç”Ÿæˆ"
          cat quality-gate-report.md
      
      - name: ä¸Šä¼ è´¨é‡é—¨ç¦æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-gate-report
          path: quality-gate-report.md