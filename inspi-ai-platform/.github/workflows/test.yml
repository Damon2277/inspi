# GitHub Actions å®Œæ•´æµ‹è¯•æµæ°´çº¿å’Œè´¨é‡é—¨ç¦
name: ğŸš€ Complete Test Pipeline & Quality Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  # æ•°æ®åº“é…ç½®
  MONGODB_URI: ${{ secrets.MONGODB_URI_TEST }}
  MONGODB_DB_NAME: 'inspi_test'
  REDIS_URL: ${{ secrets.REDIS_URL_TEST }}
  REDIS_DB: '1'
  
  # AIæœåŠ¡é…ç½®
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY_TEST }}
  GEMINI_MODEL: 'gemini-pro'
  AI_REQUEST_TIMEOUT: '30000'
  
  # åº”ç”¨é…ç½®
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET_TEST }}
  NEXTAUTH_URL: 'http://localhost:3000'
  JWT_SECRET: ${{ secrets.JWT_SECRET_TEST }}
  
  # æµ‹è¯•é…ç½®
  TEST_TIMEOUT: '60000'
  TEST_RETRIES: '2'
  PLAYWRIGHT_BROWSERS_PATH: '0'
  TARGET_URL: 'http://localhost:3000'
  
  # æ€§èƒ½æµ‹è¯•é…ç½®
  PERFORMANCE_BUDGET_CPU: '5000'
  PERFORMANCE_BUDGET_MEMORY: '100'
  PERFORMANCE_BUDGET_NETWORK: '2000'
  
  # å®‰å…¨æµ‹è¯•é…ç½®
  SECURITY_SCAN_LEVEL: 'medium'
  OWASP_ZAP_TIMEOUT: '300'
  
  # è´¨é‡é—¨ç¦é…ç½®
  COVERAGE_THRESHOLD: '90'
  PERFORMANCE_THRESHOLD: '3000'
  SECURITY_THRESHOLD: '0'
  QUALITY_GATE_ENABLED: 'true'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-format:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run Prettier
        run: npm run format:check

      - name: Run TypeScript check
        run: npm run type-check

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: ğŸ§ª å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit -- --coverage --watchAll=false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unit
          name: unit-tests

      - name: Archive test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-results
          path: |
            coverage/
            test-results/

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint-and-format
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for services
        run: |
          sleep 10
          npm run test:services

      - name: Run integration tests
        run: npm run test:integration

      - name: Archive test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: test-results/

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: ğŸ­ ç«¯åˆ°ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start &
          sleep 30
          curl -f http://localhost:3000 || exit 1

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start &
          sleep 30

      - name: Run performance tests
        run: npm run test:performance

      - name: Upload performance results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results
          path: test-results/performance/

  # å®‰å…¨æµ‹è¯•
  security-tests:
    name: ğŸ”’ å®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run security tests
        run: npm run test:security

      - name: Run OWASP ZAP scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:3000'

  # ç§»åŠ¨ç«¯æµ‹è¯•
  mobile-tests:
    name: ğŸ“± ç§»åŠ¨ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start &
          sleep 30

      - name: Run mobile tests
        run: npm run test:mobile

      - name: Upload mobile test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: mobile-test-results
          path: test-results/mobile/

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-report:
    name: ğŸ“Š æµ‹è¯•æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, security-tests, mobile-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all test results
        uses: actions/download-artifact@v3
        with:
          path: test-artifacts/

      - name: Generate comprehensive report
        run: npm run test:report

      - name: Upload comprehensive report
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-test-report
          path: test-reports/

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportPath = path.join('test-reports', 'latest-report.json');
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const statusIcon = report.summary.status === 'PASS' ? 'âœ…' : 'âŒ';
              const passRate = report.summary.passRate.toFixed(1);
              const coverage = report.summary.coverageRate.toFixed(1);
              
              const comment = `## ${statusIcon} æµ‹è¯•ç»“æœæŠ¥å‘Š
              
              | æŒ‡æ ‡ | ç»“æœ |
              |------|------|
              | æ€»ä½“çŠ¶æ€ | ${report.summary.status} |
              | é€šè¿‡ç‡ | ${passRate}% (${report.totalPassed}/${report.totalTests}) |
              | ä»£ç è¦†ç›–ç‡ | ${coverage}% |
              | æ€»è€—æ—¶ | ${(report.totalDuration / 1000).toFixed(1)}ç§’ |
              
              ### å„æµ‹è¯•å¥—ä»¶ç»“æœ
              ${report.suites.map(suite => 
                `- **${suite.suite}**: ${suite.failed === 0 ? 'âœ…' : 'âŒ'} ${suite.passed}é€šè¿‡ ${suite.failed}å¤±è´¥`
              ).join('\n')}
              
              ${report.summary.status === 'FAIL' ? 'âš ï¸ å­˜åœ¨æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æ—¥å¿—ã€‚' : 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼'}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.error('Failed to post test results:', error);
            }

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-test:
    name: ğŸš€ éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Deploy to test environment
        run: |
          echo "Deploying to test environment..."
          # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬

      - name: Run smoke tests
        run: npm run test:smoke

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸŒŸ éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, security-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Deploy to production
        run: |
          echo "Deploying to production..."
          # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬

      - name: Run production smoke tests
        run: npm run test:smoke:production

      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸ‰ Production deployment successful!"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼ˆSlackã€é‚®ä»¶ç­‰ï¼‰

  # è´¨é‡é—¨ç¦æ£€æŸ¥
  quality-gate:
    name: ğŸšª è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, security-tests]
    if: always() && env.QUALITY_GATE_ENABLED == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all test artifacts
        uses: actions/download-artifact@v3
        with:
          path: test-artifacts/

      - name: Generate quality gate report
        run: |
          echo "# ğŸšª è´¨é‡é—¨ç¦æŠ¥å‘Š" > quality-gate-report.md
          echo "" >> quality-gate-report.md
          echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> quality-gate-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> quality-gate-report.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> quality-gate-report.md
          echo "" >> quality-gate-report.md
          echo "## ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»" >> quality-gate-report.md
          echo "" >> quality-gate-report.md
          
          # æ£€æŸ¥å„ä¸ªjobçš„çŠ¶æ€
          echo "| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | ç»“æœ |" >> quality-gate-report.md
          echo "|----------|------|------|" >> quality-gate-report.md
          
          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âœ… é€šè¿‡ | æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ |" >> quality-gate-report.md
          else
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âŒ å¤±è´¥ | å­˜åœ¨å•å…ƒæµ‹è¯•å¤±è´¥ |" >> quality-gate-report.md
          fi
          
          if [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "| ğŸ”— é›†æˆæµ‹è¯• | âœ… é€šè¿‡ | æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ |" >> quality-gate-report.md
          else
            echo "| ğŸ”— é›†æˆæµ‹è¯• | âŒ å¤±è´¥ | å­˜åœ¨é›†æˆæµ‹è¯•å¤±è´¥ |" >> quality-gate-report.md
          fi
          
          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "| ğŸ­ ç«¯åˆ°ç«¯æµ‹è¯• | âœ… é€šè¿‡ | æ‰€æœ‰E2Eæµ‹è¯•é€šè¿‡ |" >> quality-gate-report.md
          else
            echo "| ğŸ­ ç«¯åˆ°ç«¯æµ‹è¯• | âŒ å¤±è´¥ | å­˜åœ¨E2Eæµ‹è¯•å¤±è´¥ |" >> quality-gate-report.md
          fi
          
          if [ "${{ needs.performance-tests.result }}" = "success" ] || [ "${{ needs.performance-tests.result }}" = "skipped" ]; then
            echo "| âš¡ æ€§èƒ½æµ‹è¯• | âœ… é€šè¿‡ | æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡ |" >> quality-gate-report.md
          else
            echo "| âš¡ æ€§èƒ½æµ‹è¯• | âŒ å¤±è´¥ | æ€§èƒ½æŒ‡æ ‡æœªè¾¾æ ‡ |" >> quality-gate-report.md
          fi
          
          if [ "${{ needs.security-tests.result }}" = "success" ] || [ "${{ needs.security-tests.result }}" = "skipped" ]; then
            echo "| ğŸ”’ å®‰å…¨æµ‹è¯• | âœ… é€šè¿‡ | æ— å®‰å…¨æ¼æ´ |" >> quality-gate-report.md
          else
            echo "| ğŸ”’ å®‰å…¨æµ‹è¯• | âŒ å¤±è´¥ | å‘ç°å®‰å…¨æ¼æ´ |" >> quality-gate-report.md
          fi
          
          echo "" >> quality-gate-report.md

      - name: Check coverage threshold
        run: |
          if [ -f "test-artifacts/unit-test-results/coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('test-artifacts/unit-test-results/coverage/coverage-summary.json')).total.lines.pct)")
            echo "å½“å‰è¦†ç›–ç‡: ${COVERAGE}%"
            echo "## ğŸ“ˆ ä»£ç è¦†ç›–ç‡æ£€æŸ¥" >> quality-gate-report.md
            echo "" >> quality-gate-report.md
            if [ $COVERAGE -ge $COVERAGE_THRESHOLD ]; then
              echo "âœ… **è¦†ç›–ç‡**: ${COVERAGE}% (â‰¥ ${COVERAGE_THRESHOLD}%)" >> quality-gate-report.md
              echo "COVERAGE_GATE=PASS" >> $GITHUB_ENV
            else
              echo "âŒ **è¦†ç›–ç‡**: ${COVERAGE}% (< ${COVERAGE_THRESHOLD}%)" >> quality-gate-report.md
              echo "COVERAGE_GATE=FAIL" >> $GITHUB_ENV
            fi
          else
            echo "âš ï¸ **è¦†ç›–ç‡**: æ— æ³•è·å–è¦†ç›–ç‡æ•°æ®" >> quality-gate-report.md
            echo "COVERAGE_GATE=UNKNOWN" >> $GITHUB_ENV
          fi
          echo "" >> quality-gate-report.md

      - name: Check performance threshold
        run: |
          echo "## âš¡ æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥" >> quality-gate-report.md
          echo "" >> quality-gate-report.md
          
          if [ -f "test-artifacts/performance-test-results/performance-summary.json" ]; then
            PERF_PASS=$(node -p "JSON.parse(require('fs').readFileSync('test-artifacts/performance-test-results/performance-summary.json')).overallPass")
            if [ "$PERF_PASS" = "true" ]; then
              echo "âœ… **æ€§èƒ½æµ‹è¯•**: æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡" >> quality-gate-report.md
              echo "PERFORMANCE_GATE=PASS" >> $GITHUB_ENV
            else
              echo "âŒ **æ€§èƒ½æµ‹è¯•**: å­˜åœ¨æ€§èƒ½æŒ‡æ ‡æœªè¾¾æ ‡" >> quality-gate-report.md
              echo "PERFORMANCE_GATE=FAIL" >> $GITHUB_ENV
            fi
          else
            echo "âš ï¸ **æ€§èƒ½æµ‹è¯•**: æ— æ³•è·å–æ€§èƒ½æ•°æ®" >> quality-gate-report.md
            echo "PERFORMANCE_GATE=UNKNOWN" >> $GITHUB_ENV
          fi
          echo "" >> quality-gate-report.md

      - name: Check security threshold
        run: |
          echo "## ğŸ”’ å®‰å…¨æ£€æŸ¥" >> quality-gate-report.md
          echo "" >> quality-gate-report.md
          
          # æ£€æŸ¥npm auditç»“æœ
          HIGH_VULNS=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.high // 0' || echo "0")
          CRITICAL_VULNS=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.critical // 0' || echo "0")
          TOTAL_HIGH_CRITICAL=$((HIGH_VULNS + CRITICAL_VULNS))
          
          if [ $TOTAL_HIGH_CRITICAL -le $SECURITY_THRESHOLD ]; then
            echo "âœ… **å®‰å…¨æ‰«æ**: æ— é«˜å±æ¼æ´ (${TOTAL_HIGH_CRITICAL}ä¸ª)" >> quality-gate-report.md
            echo "SECURITY_GATE=PASS" >> $GITHUB_ENV
          else
            echo "âŒ **å®‰å…¨æ‰«æ**: å‘ç°${TOTAL_HIGH_CRITICAL}ä¸ªé«˜å±æ¼æ´" >> quality-gate-report.md
            echo "SECURITY_GATE=FAIL" >> $GITHUB_ENV
          fi
          echo "" >> quality-gate-report.md

      - name: Determine overall quality gate status
        run: |
          echo "## ğŸ¯ è´¨é‡é—¨ç¦ç»“æœ" >> quality-gate-report.md
          echo "" >> quality-gate-report.md
          
          # æ£€æŸ¥å¿…éœ€çš„æµ‹è¯•æ˜¯å¦é€šè¿‡
          REQUIRED_TESTS_PASS=true
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            REQUIRED_TESTS_PASS=false
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            REQUIRED_TESTS_PASS=false
          fi
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            REQUIRED_TESTS_PASS=false
          fi
          
          # æ£€æŸ¥è´¨é‡é—¨ç¦
          QUALITY_GATES_PASS=true
          if [ "$COVERAGE_GATE" = "FAIL" ]; then
            QUALITY_GATES_PASS=false
          fi
          if [ "$PERFORMANCE_GATE" = "FAIL" ]; then
            QUALITY_GATES_PASS=false
          fi
          if [ "$SECURITY_GATE" = "FAIL" ]; then
            QUALITY_GATES_PASS=false
          fi
          
          if [ "$REQUIRED_TESTS_PASS" = "true" ] && [ "$QUALITY_GATES_PASS" = "true" ]; then
            echo "ğŸ‰ **è´¨é‡é—¨ç¦: é€šè¿‡**" >> quality-gate-report.md
            echo "" >> quality-gate-report.md
            echo "æ‰€æœ‰å¿…éœ€çš„æµ‹è¯•éƒ½å·²é€šè¿‡ï¼Œä»£ç è´¨é‡è¾¾åˆ°å‘å¸ƒæ ‡å‡†ã€‚" >> quality-gate-report.md
            echo "OVERALL_QUALITY_GATE=PASS" >> $GITHUB_ENV
          else
            echo "ğŸš« **è´¨é‡é—¨ç¦: å¤±è´¥**" >> quality-gate-report.md
            echo "" >> quality-gate-report.md
            if [ "$REQUIRED_TESTS_PASS" = "false" ]; then
              echo "- âŒ å­˜åœ¨å¿…éœ€æµ‹è¯•å¤±è´¥" >> quality-gate-report.md
            fi
            if [ "$QUALITY_GATES_PASS" = "false" ]; then
              echo "- âŒ å­˜åœ¨è´¨é‡æŒ‡æ ‡æœªè¾¾æ ‡" >> quality-gate-report.md
            fi
            echo "" >> quality-gate-report.md
            echo "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åé‡æ–°æäº¤ã€‚" >> quality-gate-report.md
            echo "OVERALL_QUALITY_GATE=FAIL" >> $GITHUB_ENV
          fi
          
          echo "" >> quality-gate-report.md
          echo "---" >> quality-gate-report.md
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*" >> quality-gate-report.md

      - name: Upload quality gate report
        uses: actions/upload-artifact@v3
        with:
          name: quality-gate-report
          path: quality-gate-report.md

      - name: Comment PR with quality gate results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('quality-gate-report.md', 'utf8');
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            } catch (error) {
              console.error('Failed to post quality gate results:', error);
            }

      - name: Set quality gate status
        run: |
          if [ "$OVERALL_QUALITY_GATE" = "PASS" ]; then
            echo "âœ… è´¨é‡é—¨ç¦é€šè¿‡"
            exit 0
          else
            echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥"
            exit 1
          fi

  # è´¨é‡ç›‘æ§å’Œé€šçŸ¥
  quality-monitoring:
    name: ğŸ“Š è´¨é‡ç›‘æ§
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download test artifacts
        uses: actions/download-artifact@v3
        with:
          path: test-artifacts/

      - name: Generate quality metrics
        run: |
          # åˆ›å»ºè´¨é‡æŒ‡æ ‡JSON
          cat > quality-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "qualityGate": "${{ needs.quality-gate.result }}",
            "testResults": {
              "unit": "${{ needs.unit-tests.result }}",
              "integration": "${{ needs.integration-tests.result }}",
              "e2e": "${{ needs.e2e-tests.result }}",
              "performance": "${{ needs.performance-tests.result }}",
              "security": "${{ needs.security-tests.result }}"
            }
          }
          EOF

      - name: Store quality metrics
        run: |
          # è¿™é‡Œå¯ä»¥å°†è´¨é‡æŒ‡æ ‡å­˜å‚¨åˆ°æ•°æ®åº“æˆ–ç›‘æ§ç³»ç»Ÿ
          echo "ğŸ“Š è´¨é‡æŒ‡æ ‡å·²ç”Ÿæˆ"
          cat quality-metrics.json

      - name: Send quality notifications
        if: needs.quality-gate.result == 'failure'
        run: |
          echo "ğŸš¨ è´¨é‡é—¨ç¦å¤±è´¥ï¼Œå‘é€é€šçŸ¥..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼ˆSlackã€é‚®ä»¶ã€é’‰é’‰ç­‰ï¼‰